

<h1><center>  计算机图形学-2021  实验报告 <center>


<h2><center> 实验二     一维弹簧振子系统模拟<center>


## 一、 实验简介

​		本实验旨在通过模拟弹簧振子系统的一维运动让同学们对物理仿真有个初步理解。

​		同学们需要利用学过的微积分知识与高中物理知识建立牛顿体系与欧拉体系/拉格朗日体系之间的联系，并且学会通过动能与势能之间的转换写出并求解简单的欧拉-拉格朗日方程，通过在” v - q”建立的相空间中比较四种数值积分（前项欧拉/四阶龙格库塔/后项欧拉/混合欧拉）的性能并模拟一维弹簧振子的运动。

​		本次实验使用 libigl作为几何处理与基本的可视化库。我们并不需要了解该库的具体细节，也可以完成作业，同学们只需要关注四种数值积分的实现即可。

## 二、 实验任务

(1) 任务 1：假设弹簧仅沿 X 轴做 1 维水平运动，且不考虑摩擦力。弹簧原长为 0，弹簧的劲度系数为 100N/m,弹簧的初始位置在 1m 处，初始速度为 0，振子质量为 1kg。  

实验要求实现四种不同的时间积分来实现对一位弹簧振子运动的模拟。正确的输出将会包含一个动态的相空间绘制图与一个弹簧振子模拟运动图。
本次实验需要按照要求对.h 文件进行补全，分别使用前向欧拉积分、四阶龙格库塔方法、 后向欧拉方法、混合欧拉方法完成。通过命令行的方式选择要运行的算法。

(2) 任务 2：其他条件不变，弹簧原长设定为大于零的变量，通过命令行的方式传入长度值。

## 三、 实验环境

主机操作系统：Windows 10 Home, 64-bit (Build 19043.1348) 10.0.19043

虚拟机平台：VMware® Workstation 16 Pro 16.1.0 build-17198959

虚拟机操作系统：Ubuntu_20.04.2.0_LTS

编译器：gcc version 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04) 

cmake版本： version 3.16.3

编辑器：Visual Studio Code 1.62.2



## 四、 原理内容推导

### # 4.1. 欧拉-拉格朗日方程的推导求解步骤

在变分力学（Variational Mechanics）或称解析力学（Analytical Mechanics）定义中，使用动能和势能来合成运动方程。根据变分原理，用泛函来定义运动：
$$
e(\mathbf f(t),\mathbf{\dot f}(t),...)\rightarrow \mathbb{R}
$$

动作是一个泛函，将 $ q $ 及其时间导数映射到一个标量值：
$$
S(\mathbf{q}(t),\mathbf{q}(t))=\int_{t1}^{t2} T(\mathbf{q}, {\mathbf{\dot q}})-V(\mathbf{q}, {\mathbf{\dot q}}) dt
$$
变分力学的基础是**最小作用原理**。最小作用原理断言，物体随时间的轨迹是使动能和势能之间的差异随时间最小化的轨迹
$$
\mathbf{q}(t) = \arg\min_{\mathbf{q}}\int_{t1}^{t2} T(\mathbf{q}, {\mathbf{\dot q}})-V(\mathbf{q}, {\mathbf{\dot q}}) dt
$$

此处用$T$来表示物体的动能，用$V$来表示其势能。$L=T-V$通常被称为拉格朗日函数。

按照拉格朗日函数的形式，前式可变换为：
$$
S(\mathbf{q}(t),\mathbf{\dot q} (t))= \int^{t_{2}}_{t_{1}}L(\mathbf{q} (t),\mathbf{\dot q} (t))dt
$$
使用微小变量$\delta$ 来描述，为：
$$
S(\mathbf{q}+\delta \mathbf{q},\mathbf{\dot q}+\delta \mathbf{\dot q})
= \int^{t_{2}}_{t_{1}}L(\mathbf{q}+\delta \mathbf{q},\mathbf{\dot q}+\delta \mathbf{\dot q})dt
$$
泰勒展开：
$$
S(\mathbf{q}+\delta \mathbf{q},\mathbf{\dot q}+\delta \mathbf{\dot q})
= \int^{t_{2}}_{t_{1}}L(\mathbf{q}, \mathbf{\dot q})dt+ \int^{t_{2}}_{t_{1}}\frac{\partial L}{\partial \mathbf{q}}\delta \mathbf{q}+\frac{\partial L}{\partial \mathbf{\dot q}}\delta  \mathbf{\dot q} dt
$$
需对于任意微小扰动均成立，故有
$$
\int^{t_{2}}_{t_{1}}\frac{\partial L}{\partial \mathbf{q}}\delta \mathbf{q}+\frac{\partial L}{\partial \mathbf{\dot q}}\delta \mathbf{\dot q} dt = 0
$$
可变换为:
$$
\int^{t_{2}}_{t_{1}}\left.{\frac{\partial L}{\partial \mathbf{q}}\delta \mathbf{q}-\frac{d}{dt}\frac{\partial L}{\partial \mathbf{\dot q}}\delta \mathbf{q} dt + \frac{\partial L}{\partial \mathbf{\dot q}}\delta \mathbf{q} }\right |^{t_{2}}_{t_{1}} = 0
$$
由于左右边界两点的值是已知的，故右边第三项的值为0，因此
$$
\int^{t_{2}}_{t_{1}}\frac{\partial L}{\partial \mathbf{q}}\delta \mathbf{q}-\frac{d}{dt}\frac{\partial L}{\partial \mathbf{\dot q}}\delta \mathbf{q} dt =0
$$
提取出 $\delta \mathbf{q}$ :
$$
\int^{t_{2}}_{t_{1}}\left(\frac{\partial L}{\partial\mathbf{q} }-\frac{d}{dt}\frac{\partial L}{\partial \mathbf{\dot q}}\right)\delta \mathbf{q} dt =0
$$

由于微小变量 $\delta \mathbf{q}$ 的大小是任意的，若要等式恒成立，被积函数必须恒为0：
$$
\frac{\partial L}{\partial\mathbf{q} }-\frac{d}{dt}\frac{\partial L}{\partial \mathbf{\dot q}}=0
$$
故得到欧拉-拉格朗日方程：
$$
\frac{d}{dt}\frac{\partial L}{\partial\dot{\mathbf{q}}}=\frac{\partial L}{\partial \mathbf{q}}
$$
### # 4.2.四种时间积分的推导与最终每一个时间步长的公式

现在的问题在于如何求解欧拉-拉格朗日方程
$$
\frac{d}{dt}\frac{\partial L}{\partial \dot{\mathbf{q}}}=\frac{\partial L}{\partial \mathbf{q}}
$$
若能够求解得出一个满足方程的函数 $q$ ,那么我们就得到了一个物理上有效的轨迹。

实际应用中，由于微分方程难以求解，故使用的是求其数值解的方法。

一维质量-弹簧模型中，势能 $V=\frac{1}{2}kx^2$ ,动能 $T=\frac{1}{2}mv^2$ 

先考虑弹簧设置在原点的情况以简化推导。此时弹簧形变量 $x=$ 物块的广义坐标 $q$。

此时的拉格朗日方程为：
$$
L=\frac{1}{2}m\dot {\mathbf q}^2-\frac{1}{2}k{\mathbf q}^2
$$
代入欧拉-拉格朗日方程，得到：
$$
\begin{aligned}
\frac{d}{dt}\frac{\partial L}{\partial \dot{\mathbf{q}}}&=\frac{\partial L}{\partial \mathbf{q}}
\\\frac{d}{dt}(m\dot{\mathbf q})&=-k \mathbf q
\\m\ddot{\mathbf q}&=-k \mathbf q
\end{aligned}
$$
即问题转化为求解常微分方程：
$$
m\ddot{\mathbf q}=-k \mathbf q
$$

#### #4.2.1：前向欧拉积分

常微分方程:
$$
m\ddot{\mathbf q}=-k \mathbf q
$$
为二阶常微分方程。

为求解，可以引入中间变量 $\dot q=v$ ,使得二阶常微分方程转化为耦合的一阶常微分方程系统：
$$
m\dot v=-kq
\\\dot q=v
$$
我们希望在后面的方程中仅出现变量 $q$ 和 $v$ (或 $\dot q$ )

可将其写为矩阵形式：
$$
\underbrace{\begin{pmatrix}
m &0 \\
0 &1
\end{pmatrix}}_A

\underbrace{\frac{d}{dt}
\begin{pmatrix}
v \\
q
\end{pmatrix}}_{\dot y}

=

\underbrace{\begin{pmatrix}
0 &-k \\
1 &0
\end{pmatrix}
\overbrace{\begin{pmatrix}
v \\
q
\end{pmatrix}}^y}_{f(y)}
$$
简化为：
$$
\mathbf{A\dot y=f(y)}
$$

对时间的导数可以用确定的差来替代：
$$
\mathbf{\dot y} \approx\frac1{\Delta t}(\mathbf{y}_{t+1}-\mathbf{y}_{t})
$$
代入得：
$$
\mathbf{y}_{t+1}=\mathbf{y}_{t}+A^{-1}\mathbf{f(y_t)}\cdot\Delta t
$$
其中：
$$
\mathbf{A}^{-1}=
\begin{pmatrix}
\frac{1}{m} &0\\
0 &1
\end{pmatrix}
\\\mathbf{f(y_t)}=
\begin{pmatrix}
m\ddot q_t\\
\dot v_t
\end{pmatrix}
=\begin{pmatrix}
-kq_t\\
v_t
\end{pmatrix}
$$
即：
$$
\begin{aligned}
v_{t+1}=v_{t}-\frac{k\cdot q_{t}}{m} \times \Delta t
\end{aligned}
$$

$$
\begin{aligned}
q_{t+1}=q_{t}+v_{t}\times\Delta t
\end{aligned}
$$

**同时也可以这样理解：**

对于连续函数，微小的时刻变化过程中，可以认为函数值的增长是线性的。下一时刻（t+1时刻）的值可以近似认为是前一时刻的值加上前一时刻的线性增长率和时间的乘积（在前一点的导数 $K$ $\times$ 微小的时间变化$\Delta$ t）
$$
\mathbf{y}_{t+1}=\mathbf{y}_{t}+K\cdot\Delta t
$$
此时使用的线性增长率 $K$ 为对应函数在t处的导数：
$$
K=A^{-1}\mathbf{f(y_t)}
=\begin{pmatrix}
\frac{-kq_t}{m}\\
v_t
\end{pmatrix}
$$
或者这样推导K：因为 
$$
v=\dot q(t),q=q(t)
$$
所以 
$$
\dot v(t)=\ddot q(t)=\frac{-k\cdot q_{t}}{m},
\\\dot q(t)=\dot q(t)=v(t)
$$
（t）作为下标，亦可写作：
$$
\dot v_{t}=\ddot q(t)=\frac{-k\cdot q_{t}}{m},
\\\dot q_{t}=\dot q(t)=v_{t}
\\K
=\begin{pmatrix}
\dot v_{t}\\
\dot q_{t}
\end{pmatrix}
=\begin{pmatrix}
\frac{-kq_t}{m}\\
v_t
\end{pmatrix}
$$
故能得到：
$$
v_{t+1}=v_{t}+\frac{-k\cdot q_{t}}{m} \times \Delta t
\\q_{t+1}=q_{t}+v_{t}\times\Delta t
$$

亦可得到与上述相同的结论。

#### #4.2.2：四阶Runge-Kutta方法

依旧通过线性增长率 $K$ 来理解较为简单。

下一时刻的值 $y_{n+1}$ 可以通过上一时刻的值 $y_{n}$ 加上上时间间隔 $\Delta t$ 和一个估算的线性增长率的乘积所决定。
此时使用的线性增长率 $K$ 由函数 $\mathbf{y}(t)$ 在$[t,t+\Delta t]$两个时刻之间一系列点的斜率的加权平均来表示。

除了初始点 $(t_0,\mathbf{y}(t_0))$ 处 $\mathbf{y}(t)$ 已知外，另外点处 $\mathbf{y}(t)$ 的值均为未知，可以通过欧拉方法计算得到，每点处 $\mathbf{y}(t)$ 的值都是以 $\mathbf{y}(t_0)$ 为基础，加上k乘以自变量的改变值。这里每一点使用欧拉方法计算$\mathbf{y}(t_0)$ 时使用的 $k$ 都是上一点处的斜率k，迭代计算，以减小误差：
$$
\mathbf{y}(t_0+\Delta t)=\mathbf{y}(t_0)+k_{上一点}\cdot\Delta t
$$

常用的一组点为：
$$
(t,\mathbf{y}(t));
\\(t+\frac{\Delta t}{2},\mathbf{y}(t)+\frac{\Delta t}{2}\cdot k_1);
\\(t+\frac{\Delta t}{2},\mathbf{y}(t)+\frac{\Delta t}{2}\cdot k_2);
\\(t+\Delta t,\mathbf{y}(t)+\Delta t\cdot k_3);
$$

$\mathbf{y}$ 的斜率 $k$ 可以表示为：       $k= \dot{\mathbf{y}}(t)=f(t,\mathbf{y}(t))$

这样：
$$
\begin{aligned}
k_1&=f[t,\mathbf{y}(t)]
\\k_2&=f[(t+\frac{\Delta t}{2}),\mathbf{y}(t)+\frac{\Delta t}{2}\cdot k_1]
\\k_3&=f[(t+\frac{\Delta t}{2}),\mathbf{y}(t)+\frac{\Delta t}{2}\cdot k_2]
\\k_4&=f[(t+\Delta t),\mathbf{y}(t)+\Delta t\cdot k_3]
\end{aligned}
$$

其中：

- *k*1是时间段开始时的斜率；
- *k*2是时间段中点的斜率，通过欧拉法采用斜率*k*1来决定*y*在点$t+\frac{\Delta t}{2}$的值；
- *k*3也是中点的斜率，但是这次采用斜率*k*2决定*y*值；
- *k*4是时间段终点的斜率，其*y*值用*k*3决定。

当四个斜率取平均时，中点的斜率有更大的权值，故最终使用的 $K$ 为:
$$
K=\frac{k_1+2k_2+2k_3+k_4}{6}
$$
本模型中，斜率 $k$ 的计算方法为：
$$
k
=\begin{pmatrix}
\dot v_{t}\\
\dot q_{t}
\end{pmatrix}
=A^{-1}\mathbf{f(y_t)}
=\begin{pmatrix}
\frac{-kq_t}{m}\\
v_t
\end{pmatrix}
$$
这样：
$$
k_1
=\begin{pmatrix}
\frac{-kq_{t_0}}{m}\\
v_{t_0}
\end{pmatrix}
\\k_2
=\begin{pmatrix}
\frac{-kq_{t_0}}{m}\\
v_{t_0}
\end{pmatrix}
$$






由于除了初始点 $(t_0,q(t_0))$ 处 $q(t)$ 已知外，另外点处 $q(t)$ 的值均为未知，故可以迭代计算，每点处 $q(t)$ 的值都是以 $q(t_0)$ 为基础，通过上一点处的k使用欧拉方法计算得到：
$$
q(t_0+\Delta t)=q(t_0)+k_{上一点}\cdot\Delta t
$$

常用的一组点为：
$$
(t,q(t));
\\(t+\frac{\Delta t}{2},q(t)+\frac{\Delta t}{2}\cdot k_1);
\\(t+\frac{\Delta t}{2},q(t)+\frac{\Delta t}{2}\cdot k_2);
\\(t+\Delta t,q(t)+\Delta t\cdot k_3);
$$

其中：

- *k*1是时间段开始时的斜率；
- *k*2是时间段中点的斜率，通过欧拉法采用斜率*k*1来决定*y*在点$t+\frac{\Delta t}{2}$的值；
- *k*3也是中点的斜率，但是这次采用斜率*k*2决定*y*值；
- *k*4是时间段终点的斜率，其*y*值用*k*3决定。

$q$ 的斜率 $k$ 可以表示为：       $k=\dot q(t)=f(t,q(t))$

这样：
$$
\begin{aligned}
k_1&=f[t,q(t)]
\\k_2&=f[(t+\frac{\Delta t}{2}),q(t)+\frac{\Delta t}{2}\cdot k_1]
\\k_3&=f[(t+\frac{\Delta t}{2}),q(t)+\frac{\Delta t}{2}\cdot k_2]
\\k_4&=f[(t+\Delta t),q(t)+\Delta t\cdot k_3]
\end{aligned}
$$
当四个斜率取平均时，中点的斜率有更大的权值，故最终使用的 $k$ 为:
$$
k=\frac{k_1+2k_2+2k_3+k_4}{6}
$$
因此可得：
$$
q_{t+1}=q_{t}+k\times\Delta t
$$

同理，可计算每一点处
$$
\\v_{t+1}=v_{t}+\frac{-k\cdot q_{t}}{m} \times \Delta t
$$

#### #4.2.3：隐式（向后）欧拉方法

与前向欧拉方法相近，但是使用的斜率是后一个时刻（t+1时刻）的斜率。这样得到的微分方程是隐式的，解之得：
$$
\begin{aligned}
v_{t+1}&=(v_{t}+a\Delta t)/(1+\frac{k}{m}\Delta t^{2})
     \\&=v_{t}+\frac{f}{m} \times \Delta t
     \\&=v_{t}+\frac{-k\cdot q_{t}}{m} \times \Delta t
\end{aligned}
$$

$$
\begin{aligned}
q_{t+1}&=q_{t}+v_{t+1}\times\Delta t
\end{aligned}
$$



#### #4.2.4：混合欧拉方法

速度的计算使用后向欧拉方法，位移的计算使用的是前向欧拉方法，得出结果为：
$$
\begin{aligned}
v_{t+1}&=v_{t}+a\times\Delta t
     \\&=v_{t}+\frac{f}{m} \times \Delta t
     \\&=v_{t}+\frac{-k\cdot q_{t}}{m} \times \Delta t
\end{aligned}
$$

$$
\begin{aligned}
q_{t+1}&=q_{t}+v_{t+1}\times\Delta t
\end{aligned}
$$

### #4.3.四种积分性能的比较与分析

效果

稳定性

·使用q-v相空间来测试这几种方法近似计算的路径和解析解（正确的路径之间的差异）

准确性

图形学中，更关心视觉准确性，也即相比是否遵循实际、绝对准确的物理轨迹，我们更关心它看起来是否令人信服

#### #4.3.1 前向欧拉积分

在q-v相空间的轨迹，从初始位置不断向外螺旋。

![](\图形学实验报告02_图片\lab02_foward_euler_phase-space_trajectory.png)

虽然十分简单，但并不十分适用于这里使用的弹簧系统的实际情况

####  #4.3.2 四阶Runge-Kutta

#### #4.3.3 后向欧拉积分

#### #4.3.4 混合欧拉积分





## 五、 代码实现与实验结果

#### #5.1.1 前向欧拉积分

####  #5.1.2 四阶Runge-Kutta

#### #5.1.3 后向欧拉积分

#### #5.1.4 混合欧拉积分



